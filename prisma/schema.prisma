generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // ← this is crucial for Vercel
}

/**
 * -------------------------
 * EXISTING / UPDATED MODELS
 * -------------------------
 */

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String                    @id @default(cuid())
  name              String?
  username          String?                   @unique
  email             String                    @unique
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  emailVerified     DateTime?
  image             String?
  onboardingStatus  OnboardingStatus          @default(PENDING)
  password          String?
  phone             String?
  role              UserRole                  @default(BUYER)
  accounts          Account[]
  bookings          Booking[]
  logisticsProfile  LogisticsProfile?
  mechanicProfile   MechanicProfile?
  orders            Order[]
  reviews           Review[]
  sessions          Session[]
  supplierProfile   SupplierProfile?
  tradeIns          TradeIn[]
  logisticsRequests LogisticsRequest[]
  mechanicBookings  MechanicBooking[]
  logisticsBookings LogisticsBooking[]
  notifications     Notification[]
  addresses         UserAddress[]
  conversations     ConversationParticipant[] // participants relation

  // Email Verification
  verificationCode   String? // 6-digit code
  verificationExpiry DateTime? // Code expires in 15 minutes

  // Password Reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Google OAuth flag
  isGoogleAuth           Boolean           @default(false)
  hasCompletedOnboarding Boolean           @default(false)
  messages               Message[]
  mechanicReviews        MechanicReview[]
  payments               Payment[]
  paymentMethods         PaymentMethod[]
  kycs                   KYC[]
  wallet                 Wallet?
  orderTrackings         OrderTracking[]
  logisticsReviews       LogisticsReview[]
  vehicles               Vehicle[]
}

model UserAddress {
  id        String  @id @default(cuid())
  userId    String
  fullName  String
  phone     String
  address   String
  city      String
  state     String
  zipCode   String?
  isDefault Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}

/**
 * MechanicProfile updated to match API usages:
 * - renamed available -> isAvailable
 * - added latitude, longitude, basePrice, isAvailable (boolean)
 * - ensure specializations is a string[] (matches APIs)
 * - added relation to MechanicReview model
 */
model MechanicProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  specialty      String
  location       String
  city           String
  businessName   String
  specialization String[] @default([]) // array for skills
  experience     Int
  address        String
  phone          String
  description    String?
  approved       Boolean  @default(false)
  rating         Float    @default(0)
  completedJobs  Int      @default(0)
  state          String
  hourlyRate     Float
  bio            String?
  certifications String[] @default([])
  verified       Boolean  @default(false)
  // NOTE: API expects isAvailable and 'latitude'/'longitude'/'basePrice'
  isAvailable    Boolean  @default(true)
  available      Boolean? // legacy alias (optional)
  latitude       Float?
  longitude      Float?
  basePrice      Float?   @default(0)
  workingHours   String?
  responseTime   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bookings MechanicBooking[]
  booking  Booking[] // existing relation

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mechanicNotifications MechanicNotification[]
  reviews               MechanicReview[] // mechanic-specific reviews
}

model MechanicBooking {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Vehicle Info
  vehicleMake  String
  vehicleModel String
  vehicleYear  String
  plateNumber  String?

  // Service Details
  serviceType    String
  customService  String?
  estimatedPrice Float

  // Schedule (APIs used date and time fields differently — keep them)
  date      String
  time      String?
  startTime String?
  endTime   String?

  // Location
  location String
  address  String
  city     String
  state    String?

  // Link to order/service
  orderLink OrderServiceLink?

  // Optional fields
  orderId    String?
  trackingId String?

  // Contact
  phone           String
  additionalNotes String?

  // Status & Assignment
  status     BookingStatus    @default(PENDING)
  mechanicId String?
  mechanic   MechanicProfile? @relation(fields: [mechanicId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([mechanicId])
  @@index([orderId])
}

/**
 * LogisticsProfile kept mostly as-is. Add currentLat/currentLng for proximity queries
 */
model LogisticsProfile {
  id                  String             @id @default(cuid())
  userId              String             @unique
  companyName         String
  vehicleType         String
  vehicleNumber       String
  licenseNumber       String
  address             String
  city                String
  state               String
  phone               String
  description         String?
  vehicleTypes        String[]           @default([])
  coverageAreas       String[]           @default([])
  verified            Boolean            @default(false)
  isAvailable         Boolean            @default(true) // changed to isAvailable
  available           Boolean? // legacy alias
  currentLat          Float?
  currentLng          Float?
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries          LogisticsRequest[]
  approved            Boolean            @default(false)
  rating              Float              @default(0)
  completedDeliveries Int                @default(0)

  bookings  LogisticsBooking[]
  reviews   LogisticsReview[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model Vehicle {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  make         String
  model        String
  year         Int
  vin          String? @unique
  color        String?
  mileage      Int?
  engineType   String?
  transmission String?
  nickname     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([vin])
}

model LogisticsReview {
  id          String           @id @default(cuid())
  logisticsId String
  logistics   LogisticsProfile @relation(fields: [logisticsId], references: [id])
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  rating      Float
  comment     String?
  createdAt   DateTime         @default(now())
}

/**
 * LogisticsBooking exists already; keep mostly as-is but ensure numeric fields present
 */
model LogisticsBooking {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Package Details
  packageType        String
  deliverySpeed      String
  packageDescription String
  packageValue       Float?
  estimatedPrice     Float

  // Pickup
  pickupAddress String
  pickupCity    String
  pickupState   String?

  // Delivery
  deliveryAddress String
  deliveryCity    String
  deliveryState   String?

  // Contact
  phone               String
  recipientName       String
  recipientPhone      String
  specialInstructions String?

  // Status & Assignment
  status   BookingStatus     @default(PENDING)
  driverId String?
  driver   LogisticsProfile? @relation(fields: [driverId], references: [id])

  // Tracking
  trackingNumber  String? @unique
  currentLocation String?

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  orderLink OrderServiceLink?

  orderId    String?
  trackingId String?

  @@index([userId])
  @@index([driverId])
  @@index([orderId])
}

model MechanicNotification {
  id         String           @id @default(cuid())
  mechanicId String
  mechanic   MechanicProfile  @relation(fields: [mechanicId], references: [id])
  type       NotificationType
  title      String
  message    String
  link       String?
  read       Boolean          @default(false)
  createdAt  DateTime         @default(now())

  @@index([mechanicId])
}

/**
 * Product, SupplierProfile, Order, OrderItem, ShippingAddress left mostly unchanged,
 * but ensure status casing matches APIs ("active"/"ACTIVE"). Adjusted where needed.
 */
model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String?  @unique
  description String?
  price       Float
  category    String
  brand       String?
  image       String?
  images      String[] @default([])
  stock       Int      @default(0)
  status      String   @default("ACTIVE")
  supplierId  String

  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  orderItems OrderItem[]
  supplier   SupplierProfile @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  reviews    Review[]
}

model Order {
  id            String   @id @default(cuid())
  trackingId    String   @unique @default(dbgenerated("('EDM-' || gen_random_uuid())"))
  userId        String
  total         Float
  status        String
  paymentMethod String
  deliveryNotes String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user               User                @relation(fields: [userId], references: [id])
  items              OrderItem[]
  shippingAddress    ShippingAddress?
  serviceLinks       OrderServiceLink[]
  payments           Payment[]
  walletTransactions WalletTransaction[]
  orderTracking      OrderTracking?
}

model ShippingAddress {
  id       String  @id @default(cuid())
  orderId  String  @unique
  fullName String
  email    String
  phone    String
  address  String
  city     String
  state    String
  zipCode  String?
  order    Order   @relation(fields: [orderId], references: [id])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

/**
 * Supplier and SupplierProfile kept with the new marketing fields previously added
 */
model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  company     String
  product     String
  price       String
  description String
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Booking {
  id              String        @id @default(cuid())
  name            String?
  email           String?
  phone           String?
  carModel        String
  service         String
  appointmentDate DateTime
  notes           String?
  status          BookingStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userId     String
  mechanicId String?

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mechanic MechanicProfile? @relation(fields: [mechanicId], references: [id])
}

model LogisticsRequest {
  id             String            @id @default(cuid())
  name           String
  email          String
  phone          String?
  pickup         String
  dropoff        String
  vehicle        String
  deliveryDate   DateTime
  notes          String?
  status         LogisticsStatus   @default(PENDING)
  trackingNumber String?           @unique
  weight         String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  userId         String
  logisticsId    String?
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  logistics      LogisticsProfile? @relation(fields: [logisticsId], references: [id])
}

model SupplierProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  businessName    String
  businessAddress String
  city            String
  state           String
  description     String?
  cacNumber       String?
  bankName        String?
  accountNumber   String?
  accountName     String?
  verified        Boolean @default(false)
  approved        Boolean @default(false)

  website   String?
  instagram String?
  facebook  String?
  twitter   String?
  whatsapp  String?
  tiktok    String?

  businessHours String?
  tagline       String?
  coverImage    String?
  logo          String?

  metaDescription String?
  keywords        String[] @default([])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  products  Product[]
}

model OrderServiceLink {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  mechanicBookingId String?          @unique
  mechanicBooking   MechanicBooking? @relation(fields: [mechanicBookingId], references: [id], onDelete: SetNull)

  logisticsBookingId String?           @unique
  logisticsBooking   LogisticsBooking? @relation(fields: [logisticsBookingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String?
  rating    Float
  comment   String?
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * Notifications (keeps existing model)
 */
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  link    String?

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

model ContactSubmission {
  id         String    @id @default(cuid())
  name       String
  email      String
  phone      String?
  subject    String
  category   String // general, supplier, mechanic, logistics, grant, support, other
  message    String    @db.Text
  status     String    @default("NEW") // NEW, READ, REPLIED, RESOLVED
  adminReply String?   @db.Text
  repliedAt  DateTime?
  repliedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@index([email])
}

model TradeIn {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  oldPart        String
  condition      String
  estimatedValue Decimal       @default(0.0)
  status         TradeInStatus @default(PENDING)
  photos         String[]      @default([])
  createdAt      DateTime      @default(now())
  approvedAt     DateTime?

  @@map("trade_ins")
}

/**
 * -------------------------
 * NEW MODELS (to support APIs)
 * -------------------------
 */

model Conversation {
  id        String   @id @default(cuid())
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())

  @@index([conversationId])
  @@index([userId])
}

/**
 * Messages (chat)
 */
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([conversationId])
  @@index([senderId])
}

/**
 * Mechanic-specific reviews (APIs reference mechanic.reviews)
 */
model MechanicReview {
  id         String          @id @default(cuid())
  mechanicId String
  mechanic   MechanicProfile @relation(fields: [mechanicId], references: [id], onDelete: Cascade)
  userId     String
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating     Float
  comment    String?
  createdAt  DateTime        @default(now())

  @@index([mechanicId])
  @@index([userId])
}

/**
 * Payment models (payment, paymentMethod)
 */
model Payment {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId          String?
  order            Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  amount           Float
  currency         String    @default("NGN")
  method           String
  status           String    @default("pending")
  gatewayReference String?   @unique
  gatewayResponse  Json?
  verifiedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([orderId])
}

/**
 * PaymentMethod for saving cards / bank details
 */
model PaymentMethod {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String // card | bank | ussd | etc
  last4         String?
  expiryMonth   String?
  expiryYear    String?
  bankName      String?
  accountNumber String?
  token         String? // tokenized card
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([userId])
}

/**
 * KYC model (kYC)
 */
model KYC {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  idType            String
  idNumber          String
  businessName      String?
  businessRegNumber String?
  address           String?
  city              String?
  state             String?
  idFrontUrl        String?
  idBackUrl         String?
  selfieUrl         String?
  businessCertUrl   String?
  status            String    @default("pending")
  submittedAt       DateTime  @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?

  @@index([userId])
  @@index([status])
}

/**
 * Wallets, transactions, withdrawals
 */
model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance   Float    @default(0)
  currency  String   @default("NGN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]
  withdrawals  Withdrawal[]
}

model WalletTransaction {
  id          String   @id @default(cuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type        String // credit | debit
  amount      Float
  description String?
  reference   String?
  orderId     String? // optional link to an order
  createdAt   DateTime @default(now())

  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([orderId])
}

model Withdrawal {
  id            String    @id @default(cuid())
  walletId      String
  wallet        Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  amount        Float
  bankCode      String
  accountNumber String
  status        String    @default("pending")
  initiatedAt   DateTime  @default(now())
  processedAt   DateTime?
  reference     String?

  @@index([walletId])
}

/**
 * Order tracking & live updates
 */
model OrderTracking {
  id                 String    @id @default(cuid())
  orderId            String    @unique
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driverId           String? // references User.id (driver)
  driver             User?     @relation(fields: [driverId], references: [id], onDelete: SetNull)
  deliveryLat        Float?
  deliveryLng        Float?
  currentLat         Float?
  currentLng         Float?
  lastLocationUpdate DateTime?
  status             String    @default("pending")
  estimatedArrival   String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  updates TrackingUpdate[]

  @@index([orderId])
  @@index([driverId])
}

/**
 * Tracking updates (location pings)
 */
model TrackingUpdate {
  id         String        @id @default(cuid())
  trackingId String
  tracking   OrderTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  latitude   Float
  longitude  Float
  status     String?
  timestamp  DateTime      @default(now())

  @@index([trackingId])
  @@index([timestamp])
}

enum TradeInStatus {
  PENDING
  APPROVED
  REJECTED
  REDEEMED
}

enum UserRole {
  BUYER
  SUPPLIER
  MECHANIC
  LOGISTICS
  ADMIN
}

enum OnboardingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum BookingStatus {
  PENDING
  ACCEPTED
  REJECTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CONFIRMED // add back
}

enum LogisticsStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
  OUT_FOR_DELIVERY // add back
}

enum NotificationType {
  ORDER
  BOOKING
  LOGISTICS
  SYSTEM
  ACCOUNT
  PRODUCT
  PAYMENT
  REVIEW
  PRODUCT_CREATED
  LOW_INVENTORY
  ORDER_STATUS_UPDATED
  DELIVERY
}
