generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Add this for connection pooling
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String             @id @default(cuid())
  name              String?
  email             String             @unique
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  emailVerified     DateTime?
  image             String?
  onboardingStatus  OnboardingStatus   @default(PENDING)
  password          String?
  phone             String?
  role              UserRole           @default(BUYER)
  accounts          Account[]
  bookings          Booking[]
  logisticsProfile  LogisticsProfile?
  mechanicProfile   MechanicProfile?
  orders            Order[]
  reviews           Review[]
  sessions          Session[]
  supplierProfile   SupplierProfile?
  tradeIns          TradeIn[]
  logisticsRequests LogisticsRequest[]
  mechanicBookings  MechanicBooking[]
  logisticsBookings LogisticsBooking[]
  notifications     Notification[]
  addresses         UserAddress[]
}

model UserAddress {
  id        String  @id @default(cuid())
  userId    String
  fullName  String
  phone     String
  address   String
  city      String
  state     String
  zipCode   String?
  isDefault Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}

model MechanicProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  specialty      String
  location       String
  city           String
  businessName   String
  specialization String[]
  experience     Int
  address        String
  phone          String
  description    String?
  approved       Boolean  @default(false)
  rating         Float    @default(0)
  completedJobs  Int      @default(0)
  state          String
  hourlyRate     Float
  bio            String?
  certifications String[]
  verified       Boolean  @default(false)
  available      Boolean  @default(true)
  workingHours   String?
  responseTime   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ‚úÖ Correct relation
  bookings MechanicBooking[]
  booking  Booking[]

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  mechanicNotifications MechanicNotification[]
}

model MechanicBooking {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Vehicle Info
  vehicleMake  String
  vehicleModel String
  vehicleYear  String
  plateNumber  String?

  // Service Details
  serviceType    String
  customService  String?
  estimatedPrice Float

  // Schedule
  date String
  time String

  // Location
  location String
  address  String
  city     String
  state    String?

  // ... existing fields ...
  orderLink OrderServiceLink?

  // Add these fields if they don't exist
  orderId    String?
  trackingId String?

  // Contact
  phone           String
  additionalNotes String?

  // Status & Assignment
  status     BookingStatus    @default(PENDING)
  mechanicId String?
  mechanic   MechanicProfile? @relation(fields: [mechanicId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([mechanicId])
  @@index([orderId])
}

model LogisticsProfile {
  id                  String             @id @default(cuid())
  userId              String             @unique
  companyName         String
  vehicleType         String
  vehicleNumber       String
  licenseNumber       String
  address             String
  city                String
  state               String
  phone               String
  description         String?
  vehicleTypes        String[]
  coverageAreas       String[]
  verified            Boolean            @default(false)
  available           Boolean            @default(true)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries          LogisticsRequest[]
  approved            Boolean            @default(false)
  rating              Float              @default(0)
  completedDeliveries Int                @default(0)

  bookings LogisticsBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LogisticsBooking {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Package Details
  packageType        String
  deliverySpeed      String
  packageDescription String
  packageValue       Float?
  estimatedPrice     Float

  // Pickup
  pickupAddress String
  pickupCity    String
  pickupState   String?

  // Delivery
  deliveryAddress String
  deliveryCity    String
  deliveryState   String?

  // Contact
  phone               String
  recipientName       String
  recipientPhone      String
  specialInstructions String?

  // Status & Assignment
  status   BookingStatus     @default(PENDING)
  driverId String?
  driver   LogisticsProfile? @relation(fields: [driverId], references: [id])

  // Tracking
  trackingNumber  String? @unique
  currentLocation String?

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  orderLink OrderServiceLink?

  // Add these fields if they don't exist
  orderId    String?
  trackingId String?

  @@index([userId])
  @@index([driverId])
  @@index([orderId])
}

model MechanicNotification {
  id         String           @id @default(cuid())
  mechanicId String
  mechanic   MechanicProfile  @relation(fields: [mechanicId], references: [id])
  type       NotificationType
  title      String
  message    String
  link       String?
  read       Boolean          @default(false)
  createdAt  DateTime         @default(now())

  @@index([mechanicId])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String?  @unique
  description String?
  price       Float
  category    String
  brand       String?
  image       String?
  images      String[] @default([])
  stock       Int      @default(0)
  status      String   @default("ACTIVE")
  supplierId  String

  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  orderItems OrderItem[]
  supplier   SupplierProfile @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  reviews    Review[]
}

// schema.prisma
model Order {
  id            String   @id @default(cuid())
  trackingId    String   @unique @default(dbgenerated("('EDM-' || gen_random_uuid())"))
  userId        String
  total         Float
  status        String
  paymentMethod String
  deliveryNotes String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user            User               @relation(fields: [userId], references: [id])
  items           OrderItem[]
  shippingAddress ShippingAddress?
  serviceLinks    OrderServiceLink[]
}

model ShippingAddress {
  id       String  @id @default(cuid()) // ‚Üê String
  orderId  String  @unique // ‚Üê String
  fullName String
  email    String
  phone    String
  address  String
  city     String
  state    String
  zipCode  String?
  order    Order   @relation(fields: [orderId], references: [id])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ADD THESE MODELS TO YOUR SCHEMA (AFTER LogisticsProfile)

model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  company     String
  product     String
  price       String
  description String
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Booking {
  id              String        @id @default(cuid())
  name            String?
  email           String?
  phone           String?
  carModel        String
  service         String
  appointmentDate DateTime
  notes           String?
  status          BookingStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userId     String
  mechanicId String?

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mechanic MechanicProfile? @relation(fields: [mechanicId], references: [id])
}

model LogisticsRequest {
  id             String            @id @default(cuid())
  name           String
  email          String
  phone          String?
  pickup         String
  dropoff        String
  vehicle        String
  deliveryDate   DateTime
  notes          String?
  status         LogisticsStatus   @default(PENDING)
  trackingNumber String?           @unique
  weight         String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  userId         String
  logisticsId    String?
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  logistics      LogisticsProfile? @relation(fields: [logisticsId], references: [id])
}

model SupplierProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  businessName    String
  businessAddress String
  city            String
  state           String
  description     String?
  cacNumber       String?
  bankName        String?
  accountNumber   String?
  accountName     String?
  verified        Boolean @default(false)
  approved        Boolean @default(false)

  // üî• NEW: Social Media Links
  website   String?
  instagram String?
  facebook  String?
  twitter   String?
  whatsapp  String?
  tiktok    String?

  // üî• NEW: Business Hours & Info
  businessHours String? // JSON string: { "monday": "9AM-6PM", ... }
  tagline       String? // Short catchy tagline
  coverImage    String? // Hero/banner image URL
  logo          String? // Business logo URL

  // üî• NEW: SEO & Marketing
  metaDescription String?
  keywords        String[] @default([])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  products  Product[]
}

model OrderServiceLink {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Mechanic booking (nullable)
  mechanicBookingId String?          @unique
  mechanicBooking   MechanicBooking? @relation(fields: [mechanicBookingId], references: [id], onDelete: SetNull)

  // Logistics booking (nullable)
  logisticsBookingId String?           @unique
  logisticsBooking   LogisticsBooking? @relation(fields: [logisticsBookingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String?
  rating    Float
  comment   String?
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  link    String?

  read Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  ORDER
  BOOKING
  PRODUCT
  SYSTEM
  PAYMENT
  DELIVERY
  REVIEW
  PRODUCT_CREATED
  LOW_INVENTORY
  ORDER_STATUS_UPDATED
}

model ContactSubmission {
  id         String    @id @default(cuid())
  name       String
  email      String
  phone      String?
  subject    String
  category   String // general, supplier, mechanic, logistics, grant, support, other
  message    String    @db.Text
  status     String    @default("NEW") // NEW, READ, REPLIED, RESOLVED
  adminReply String?   @db.Text
  repliedAt  DateTime?
  repliedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@index([email])
}

model TradeIn {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  oldPart        String
  condition      String
  estimatedValue Decimal       @default(0.0) // ‚Üê This is Naira (‚Ç¶5000.00)
  status         TradeInStatus @default(PENDING)
  photos         String[]
  createdAt      DateTime      @default(now())
  approvedAt     DateTime?

  @@map("trade_ins")
}

enum TradeInStatus {
  PENDING
  APPROVED
  REJECTED
  REDEEMED
}

enum UserRole {
  BUYER
  SUPPLIER
  MECHANIC
  LOGISTICS
  ADMIN
}

enum OnboardingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LogisticsStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}
